<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Auth Auto Test</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background: #1a1a1a;
            color: #00ff00;
            padding: 20px;
            margin: 0;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            color: #00ffff;
            border-bottom: 2px solid #00ffff;
            padding-bottom: 10px;
        }
        .test-section {
            background: #2a2a2a;
            border: 1px solid #444;
            border-radius: 5px;
            padding: 15px;
            margin: 15px 0;
        }
        .test-title {
            color: #ffff00;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .result {
            margin: 5px 0;
            padding: 8px;
            border-radius: 3px;
        }
        .success {
            background: #004400;
            color: #00ff00;
            border-left: 3px solid #00ff00;
        }
        .error {
            background: #440000;
            color: #ff0000;
            border-left: 3px solid #ff0000;
        }
        .info {
            background: #000044;
            color: #00aaff;
            border-left: 3px solid #00aaff;
        }
        .warning {
            background: #444400;
            color: #ffff00;
            border-left: 3px solid #ffff00;
        }
        pre {
            background: #000;
            padding: 10px;
            border-radius: 3px;
            overflow-x: auto;
            margin: 5px 0;
        }
        .config {
            background: #1a1a1a;
            border: 1px solid #555;
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
        }
        input {
            background: #000;
            color: #00ff00;
            border: 1px solid #555;
            padding: 8px;
            margin: 5px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
        }
        button {
            background: #006600;
            color: #00ff00;
            border: 1px solid #00ff00;
            padding: 10px 20px;
            margin: 10px 5px;
            border-radius: 3px;
            cursor: pointer;
            font-weight: bold;
        }
        button:hover {
            background: #008800;
        }
        .running {
            color: #ffff00;
        }
        .summary {
            background: #2a2a2a;
            border: 2px solid #00ffff;
            padding: 20px;
            margin: 20px 0;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîê Admin Authentication Auto Test</h1>
        
        <div class="config">
            <h3 style="color: #ffff00;">Configuration</h3>
            <div>
                <label>Admin Email:</label>
                <input type="text" id="adminEmail" value="admin@saree4ever.com" style="width: 300px;">
            </div>
            <div>
                <label>Admin Password:</label>
                <input type="password" id="adminPassword" value="" placeholder="Enter your password" style="width: 300px;">
            </div>
            <div>
                <label>API URL:</label>
                <input type="text" id="apiUrl" value="http://localhost:5001/api" style="width: 300px;">
            </div>
            <button onclick="runAllTests()">‚ñ∂Ô∏è Run All Tests</button>
            <button onclick="clearAuthAndTest()">üîÑ Clear Auth & Test</button>
            <button onclick="clearResults()">üóëÔ∏è Clear Results</button>
            <button onclick="clearAuth()">üîì Clear Auth Data</button>
        </div>

        <div id="results"></div>
    </div>

    <script>
        const API_URL = () => document.getElementById('apiUrl').value;
        const ADMIN_EMAIL = () => document.getElementById('adminEmail').value;
        const ADMIN_PASSWORD = () => document.getElementById('adminPassword').value;

        function log(message, type = 'info') {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `result ${type}`;
            div.innerHTML = message;
            results.appendChild(div);
            console.log(message);
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
        }

        function clearAuth() {
            localStorage.removeItem('token');
            localStorage.removeItem('admin_token');
            localStorage.removeItem('admin_auth');
            log('‚úÖ Authentication data cleared from localStorage', 'success');
        }

        function clearAuthAndTest() {
            clearAuth();
            setTimeout(() => {
                runAllTests();
            }, 500);
        }

        async function testBackendHealth() {
            log('<div class="test-title">Test 1: Backend Health Check</div>', 'info');
            
            try {
                const response = await fetch('http://localhost:5001/health');
                const data = await response.json();
                
                if (response.ok) {
                    log(`‚úÖ Backend is running: ${JSON.stringify(data)}`, 'success');
                    return true;
                } else {
                    log(`‚ùå Backend returned error: ${JSON.stringify(data)}`, 'error');
                    return false;
                }
            } catch (error) {
                log(`‚ùå Backend not responding: ${error.message}`, 'error');
                log(`‚ö†Ô∏è Make sure backend is running on port 5001`, 'warning');
                return false;
            }
        }

        async function testCurrentAuth() {
            log('<div class="test-title">Test 2: Current Authentication Status</div>', 'info');
            
            const token = localStorage.getItem('token') || localStorage.getItem('admin_token');
            const adminAuth = localStorage.getItem('admin_auth');
            
            if (token) {
                log(`‚úÖ Token found: ${token.substring(0, 30)}...`, 'success');
                log(`‚úÖ Admin auth flag: ${adminAuth}`, 'success');
                return token;
            } else {
                log(`‚ö†Ô∏è No token found in localStorage`, 'warning');
                log(`‚ÑπÔ∏è You need to login first`, 'info');
                return null;
            }
        }

        async function testAdminLogin() {
            log('<div class="test-title">Test 3: Admin Login</div>', 'info');
            
            const email = ADMIN_EMAIL();
            const password = ADMIN_PASSWORD();
            
            if (!password) {
                log(`‚ùå Password not set. Please enter password in config above.`, 'error');
                return null;
            }
            
            log(`‚ÑπÔ∏è Attempting login with email: ${email}`, 'info');
            
            try {
                const response = await fetch(`${API_URL()}/auth/admin/signin`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                
                const data = await response.json();
                
                // Log response details for debugging
                log(`‚ÑπÔ∏è Response status: ${response.status} ${response.statusText}`, 'info');
                
                if (response.ok && data.token) {
                    log(`‚úÖ Login successful!`, 'success');
                    log(`‚úÖ Token received: ${data.token.substring(0, 30)}...`, 'success');
                    
                    localStorage.setItem('token', data.token);
                    localStorage.setItem('admin_token', data.token);
                    localStorage.setItem('admin_auth', 'true');
                    
                    log(`‚úÖ Token stored in localStorage`, 'success');
                    log(`‚úÖ User: ${data.user?.email} (${data.user?.role})`, 'success');
                    
                    return data.token;
                } else {
                    // Login failed - show detailed error
                    log(`‚ùå Login FAILED!`, 'error');
                    log(`‚ùå Status: ${response.status} ${response.statusText}`, 'error');
                    log(`‚ùå Error: ${data.error || data.message || 'Unknown error'}`, 'error');
                    log(`<pre>${JSON.stringify(data, null, 2)}</pre>`, 'error');
                    
                    if (response.status === 401) {
                        log(`‚ö†Ô∏è Invalid email or password. Check your credentials.`, 'warning');
                    } else if (response.status === 403) {
                        log(`‚ö†Ô∏è Admin access denied. Make sure email is in ADMIN_EMAILS in backend .env`, 'warning');
                    } else if (response.status === 400) {
                        log(`‚ö†Ô∏è Bad request. Check that email and password are provided.`, 'warning');
                    }
                    
                    return null;
                }
            } catch (error) {
                log(`‚ùå Network error: ${error.message}`, 'error');
                log(`‚ö†Ô∏è Make sure backend is running on port 5001`, 'warning');
                return null;
            }
        }

        async function testHeroSlidesAPI(token) {
            log('<div class="test-title">Test 4: Hero Slides API (Protected Endpoint)</div>', 'info');
            
            if (!token) {
                log(`‚ùå No token provided`, 'error');
                return false;
            }
            
            log(`‚ÑπÔ∏è Testing API call with token...`, 'info');
            
            try {
                const response = await fetch(`${API_URL()}/hero-slides`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    log(`‚úÖ API call successful!`, 'success');
                    log(`‚úÖ Received ${data.slides?.length || 0} hero slides`, 'success');
                    log(`<pre>${JSON.stringify(data, null, 2)}</pre>`, 'info');
                    return true;
                } else {
                    const error = await response.json();
                    log(`‚ùå API call failed: ${error.error || JSON.stringify(error)}`, 'error');
                    if (response.status === 401) {
                        log(`‚ö†Ô∏è Authentication failed. Token may be invalid or expired.`, 'warning');
                    }
                    return false;
                }
            } catch (error) {
                log(`‚ùå Request error: ${error.message}`, 'error');
                return false;
            }
        }

        async function testTypesAPI(token) {
            log('<div class="test-title">Test 5: Types API (Public Endpoint)</div>', 'info');
            
            try {
                const response = await fetch(`${API_URL()}/types`);
                
                if (response.ok) {
                    const data = await response.json();
                    log(`‚úÖ Types API works!`, 'success');
                    log(`‚úÖ Received ${data.types?.length || 0} types`, 'success');
                    return true;
                } else {
                    const error = await response.json();
                    log(`‚ùå Types API failed: ${error.error || JSON.stringify(error)}`, 'error');
                    return false;
                }
            } catch (error) {
                log(`‚ùå Request error: ${error.message}`, 'error');
                return false;
            }
        }

        async function testCategoriesAPI(token) {
            log('<div class="test-title">Test 6: Categories API (Public Endpoint)</div>', 'info');
            
            try {
                const response = await fetch(`${API_URL()}/categories`);
                
                if (response.ok) {
                    const data = await response.json();
                    log(`‚úÖ Categories API works!`, 'success');
                    log(`‚úÖ Received ${data.categories?.length || 0} categories`, 'success');
                    return true;
                } else {
                    const error = await response.json();
                    log(`‚ùå Categories API failed: ${error.error || JSON.stringify(error)}`, 'error');
                    return false;
                }
            } catch (error) {
                log(`‚ùå Request error: ${error.message}`, 'error');
                return false;
            }
        }

        async function runAllTests() {
            clearResults();
            log('<div class="summary"><h2 style="color: #00ffff;">üöÄ Starting All Tests...</h2></div>', 'info');
            
            const results = {
                backend: false,
                login: false,
                heroSlides: false,
                types: false,
                categories: false
            };
            
            // Test 1: Backend Health
            results.backend = await testBackendHealth();
            if (!results.backend) {
                log('<div class="summary"><h3 style="color: #ff0000;">‚ùå Backend not running. Please start backend server first.</h3></div>', 'error');
                return;
            }
            
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // Test 2: Check current auth (informational only)
            const existingToken = await testCurrentAuth();
            
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // Test 3: Always test login with provided credentials
            log('<div class="test-title">Test 3: Admin Login (Testing with provided credentials)</div>', 'info');
            const token = await testAdminLogin();
            results.login = !!token;
            
            if (!token) {
                log(`‚ö†Ô∏è Login failed. Cannot proceed with protected API tests.`, 'warning');
            }
            
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // Test 4: Protected API
            if (token) {
                results.heroSlides = await testHeroSlidesAPI(token);
            }
            
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // Test 5: Public APIs
            results.types = await testTypesAPI();
            
            await new Promise(resolve => setTimeout(resolve, 500));
            
            results.categories = await testCategoriesAPI();
            
            // Summary
            const passed = Object.values(results).filter(r => r).length;
            const total = Object.keys(results).length;
            
            log(`<div class="summary">
                <h2 style="color: ${passed === total ? '#00ff00' : '#ffff00'};">üìä Test Summary</h2>
                <p>‚úÖ Passed: ${passed}/${total}</p>
                <ul>
                    <li>Backend Health: ${results.backend ? '‚úÖ' : '‚ùå'}</li>
                    <li>Admin Login: ${results.login ? '‚úÖ' : '‚ùå'}</li>
                    <li>Hero Slides API: ${results.heroSlides ? '‚úÖ' : '‚ùå'}</li>
                    <li>Types API: ${results.types ? '‚úÖ' : '‚ùå'}</li>
                    <li>Categories API: ${results.categories ? '‚úÖ' : '‚ùå'}</li>
                </ul>
                ${passed === total ? '<h3 style="color: #00ff00;">üéâ All tests passed!</h3>' : '<h3 style="color: #ff0000;">‚ö†Ô∏è Some tests failed. Check errors above.</h3>'}
            </div>`, passed === total ? 'success' : 'warning');
        }

        // Auto-run on page load
        window.addEventListener('load', () => {
            log('<div class="summary"><h2>üîê Admin Authentication Test Suite</h2><p>Configure your credentials above and click "Run All Tests"</p></div>', 'info');
            
            // Check if password is already set
            const passwordInput = document.getElementById('adminPassword');
            const savedPassword = sessionStorage.getItem('test_password');
            if (savedPassword) {
                passwordInput.value = savedPassword;
            }
            
            // Save password to session storage
            passwordInput.addEventListener('change', () => {
                sessionStorage.setItem('test_password', passwordInput.value);
            });
        });
    </script>
</body>
</html>

